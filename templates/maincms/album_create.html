{% extends 'maincms_base.html' %}
{% block content %}
{% include "maincms/navbar.html" %}
{% load static %}
<meta name="csrf-token" content="{{ csrf_token }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="{% static 'maincms/js/test.js' %}"></script>
<!-- 앨범 정보 상자 -->
 
<div class=".container-fluid" style="height: 100vh; padding-top: 81px;">
    <div class="d-flex flex-row d-flex align-items-start mb-3" style="height: -webkit-fill-available;">
        <div>
            {% include "maincms/sidebar.html" %}
        </div>
        <div>
            <div class="container-lg my-4 py-3">
                <div class="info-field"><h5 class="fw-bold">앨범 정보</h5><input class="form-in" type="text" name="album_code"></div>
                <div class="info-field mb-5" id="album_info">
                    <div class="info-field-column" style="width: 320px;">
                        <div id="cover-box">
                            <p>앨범 커버 업로드</p>
                            <input type="file" id="cover-input" style="display: none;" accept="image/*">
                            <img id="cover-preview" src="" alt="앨범 커버 미리보기" style="display:none; width: 100%; height: 100%; object-fit: cover;">
                            
                        </div>
                        <a class="btn btn-outline-primary btn-sm my-3" id="excel_data_up" role="button" style="width: 150px;">데이터 업로드</a>
                    </div>
                    <div class="info-field-column left-auto">
                        <div class="info-field">
                            <div class="label-field"><i class="bi bi-check check"></i>앨범명(국문)</div><input class="form-in" type="text" name="album_title">
                            <div class="label-field"><i class="bi bi-check"></i>앨범명(영문)</div><input class="form-in" type="text" name="album_title_en">
                        </div>
                        <div class="info-field">
                            <div class="label-field"><i class="bi bi-check check"></i>아티스트</div><input class="form-in" type="text" data-modal="modal1" id="album_artist" name="album_artist">
                            <div class="label-field"><i class="bi bi-check check"></i>앨범장르</div>
                            <select class="form-select-sm" id="album_genre" name="album_genre" style="width: 203px;">
                                <option selected>선택하세요</option>
                                <option value="POP">POP</option>
                                <option value="Dance">Dance</option>
                                <option value="Hiphop">Hiphop</option>
                                <option value="Newage">Newage</option>
                                <option value="Indie pop">Indie pop</option>
                                <option value="Indie">Indie</option>
                                <option value="Indie Rock">Indie Rock</option>
                                <option value="Indie Folk">Indie Folk</option>
                                <option value="Folk">Folk</option>
                                <option value="World">World</option>
                                <option value="OST">OST</option>
                                <option value="Trot">Trot</option>
                                <option value="Instrumental">Instrumental</option>
                            </select>
                        </div>
                        <div class="info-field">
                            <div class="label-field"><i class="bi bi-check check"></i>앨범유형</div>
                            <select class="form-select-sm" name="album_Categ" style="width: 203px;">
                                <option selected>선택하세요</option>
                                <option value="싱글">싱글</td>
                                <option value="EP">EP</td>
                                <option value="정규">정규</td>
                                <option value="OST">OST</td>
                            </select>
                            <div class="label-field"><i class="bi bi-check check"></i>발매국가</div>
                            <select class="form-select-sm" name="album_country" style="width: 203px;">
                                <option selected>선택하세요</option>
                                <option value="Korea">한국</option>
                                <option value="USA">미국</option>
                                <option value="Jepan">일본</option>
                            </select>
                        </div>
                        <div class="info-field">
                            <div class="label-field"><i class="bi bi-check"></i>UPC</div><input class="form-in" type="text" name="UPC">
                            <div class="label-field"><i class="bi bi-check"></i>UCI</div><input class="form-in" type="text" name="UCI">
                        </div>
                        <div class="info-field">
                            <div class="label-field"><i class="bi bi-check check"></i>기획사</div><input class="form-in" type="text" name="album_copyright">
                            <div class="label-field"><i class="bi bi-check check"></i>유통사</div><input class="form-in" type="text" name="album_publish">
                        </div>
                        <div class="info-field">
                            <div class="label-field"><i class="bi bi-check check"></i>발매일</div><input class="form-in datepicker" type="text" name="startdate" style="width: 203px;">
                            <div class="label-field"><i class="bi bi-check check"></i>오픈일</div><input class="form-in datepicker" id="opendate" type="text" name="opendate" style="width: 203px;">
                        </div>
                        <div class="info-field">
                            <div class="label-field"><i class="bi bi-check check"></i>앨범코드</div><input class="form-in" type="text" name="albumcode" style="width: 203px;">
                        </div>
                    </div>
                </div>
                <h5 class="fw-bold">아티스트 정보</h5>
                <div id="artist_container">
                    <div class="info-field-start mb-2" id="artist_info">
                        <div class="label-field"><i class="bi bi-check check"></i>아티스트 찾기</div>
                        <select class="form-select-sm artist-role" style="width: 120px;">
                            <option selected>선택하세요</option>
                            <option value="Main">메인</option>
                            <option value="With">참여</option>
                            <option value="Feat">피쳐링</option>
                        </select>
                        <input class="form-in find_artist" type="text" data-modal="modal1">
                        <input class="form-in artist-code" type="text" name="album_artist_code" style="width: 120px;" disabled>
                        <a class="btn btn-outline-danger btn-sm artist-add">추가</a>
                    </div>
                </div>
                <input class="form-in" type="text" id="album_artist_roll" style="width: 120px; display: none;">
                <input class="form-in" type="text" id="album_artist_id_roll" style="width: 120px; display: none;"name="main_artist_id">
                <input class="form-in" type="text" id="album_with_artist_roll" style="width: 120px; display: none;" name="with_main_artist">
                <input class="form-in" type="text" id="album_feat_artist_roll" style="width: 120px; display: none;" name="feat_main_artist">
                <input class="form-in" type="text" id="album_with_artist_id_roll" style="width: 120px; display: none;" name="with_main_artist_id">
                <input class="form-in" type="text" id="album_feat_artist_id_roll" style="width: 120px; display: none;" name="feat_main_artist_id">
                <a class="btn btn-outline-primary btn-sm my-3" id="artist_summit" role="button" style="width: 150px;">아티스트 등록</a>
                <h5 class="fw-bold">권리자 정보</h5>
                <div class="info-field mb-5" id="user_info">
                    <div class="label-field"><i class="bi bi-check check"></i>권리자 찾기</div><input class="form-in" type="text" data-modal="modal3" id="right_holder"  name="rightholder_code">
                    <div class="label-field"><i class="bi bi-check check"></i>정산 수수료율</div><input class="form-in" type="text" name="allocation_rate">
                </div>
                <h5 class="fw-bold">서비스 정보 및 옵션</h5>
                <div class="info-field mb-5" id="service_option">
                    <div class="info-field-column">
                        <div class="info-field">               
                            <div class="label-field"><i class="bi bi-check check"></i>서비스 영역</div>
                            <select class="form-select-sm" name="service_area" style="width: 203px;">
                                <option selected>선택하세요</option>
                                <option value="전세계">전세계</option>
                                <option value="국내">국내</option>
                                <option value="해외">해외</option>
                            </select>
                        </div>
                        <div class="info-field"><div class="label-field"><i class="bi bi-check"></i>제외 국가</div><input class="form-in" type="text" name="excluded"></div>
                        <div class="info-field">               
                            <div class="label-field"><i class="bi bi-check check"></i>Youtube 서비스</div>
                            <select class="form-select-sm" name="YT_service" style="width: 203px;">
                                <option selected>선택하세요</option>
                                <option value="AT+CID">AT+CID</option>
                                <option value="AT_Only">AT_Only</option>
                            </select>
                        </div>
                    </div>
                    <div class="info-field-column">
                        <div class="info-field">               
                            <div class="label-field"><i class="bi bi-check check"></i>서비스 언어</div>
                            <select class="form-select-sm" id="service_lang" name="service_lang" style="width: 203px;">
                                <option selected>선택하세요</option>
                                <option value="한국어">한국어</option>
                                <option value="영어">영어</option>
                                <option value="일본어">일본어</option>
                            </select>
                        </div>
                        <div class="info-field">               
                            <div class="label-field"><i class="bi bi-check check"></i>서비스 시간</div>
                            <select class="form-select-sm" name="service_time" style="width: 203px;">
                                <option selected>선택하세요</option>
                                <option value="12:00">12:00</option>
                                <option value="18:00">18:00</option>
                            </select>
                        </div>
                        <div class="info-field">               
                            <div class="label-field"><i class="bi bi-check"></i>프로모션 유무</div>
                            <select class="form-select-sm" name="promotion" style="width: 203px;">
                                <option selected>선택하세요</option>
                                <option value="Y">Y</option>
                                <option value="N">N</option>
                            </select>
                        </div>
                    </div>
                    <div class="info-field-column">
                        <a class="btn btn-outline-primary btn-sm my-1" id="setdateButton" role="button" style="width: 150px;">발매일 동기화</a>
                        <a class="btn btn-outline-primary btn-sm my-1" id="setgenreButton" role="button" style="width: 150px;">장르 동기화</a>
                        <a class="btn btn-outline-primary btn-sm my-1" id="setArtistButton" role="button" style="width: 150px;">곡 아티스트 동기화</a>
                    </div>
                    <div class="info-field-column">
                        <a class="btn btn-outline-primary btn-sm my-1" href="#" style="width: 150px;">UPC 발급</a>
                        <a class="btn btn-outline-primary btn-sm my-1" id="setLangButton" role="button" style="width: 150px;">언어 동기화</a>
                        <a class="btn btn-outline-primary btn-sm my-1" href="#" style="width: 150px;">UCI 발급</a>
                    </div>
                </div>
                <h5 class="fw-bold">디스크 / 트랙 정보</h5>
                <div class="info-field-start mb-5" id="service_option">
                    <div class="label-field"><i class="bi bi-check check"></i>디스크 번호</div><input class="form-ck" type="text" id="disc_total_num" style="width: 31px;" value="1">
                    <div class="label-field"><i class="bi bi-check check"></i>트랙 수</div><input class="form-ck" type="text" id="track_total_num" style="width: 31px;" value="1">
                    <a class="btn btn-primary btn-sm my-1" role="button" id="generate" style="margin-left: 30px;">디스크 만들기</a>
                </div>
                <table class="table" id="result-table">
                    <thead class="table-light">
                        <tr>
                        <th scope="col-1" class="text-center" style="width:50px;">DISK</th>
                        <th scope="col-1" class="text-center" style="width:50px;">NO.</th>
                        <th scope="col" class="text-center">Song title</th>
                        <th scope="col" class="text-center"style="width:400px;">Artist</th>
                        <th scope="col" class="text-center" style="width:100px;">상세보기</th>
                        </tr>
                    </thead>
                    <!-- 반복 규정된 테이블 
                    <tbody id="1_1">
                        <tr>
                            <th class='text-center' ><input class="form-ck" type="number" id="disk_no_1" name="disk_no[]" style="width: 31px;"></div></th>
                            <th class='text-center' ><input class="form-ck" type="number" id="track_no_1" name="track_no[]" style="width: 31px;"></div></th>
                            <th class='text-center' id="song_title_view_1_1"></th>
                            <th class='text-center' id="artist_view_1_1"></th>
                            <th class='text-center'><i class="bi bi-chevron-up icon" data-target="detail_1_1"></i></td>
                        </tr>
                        <tr id="detail_1_1">
                            <th colspan='3'>
                                <div class="info-field">
                                    <div class="info-field-column">
                                        <div class="info-field">
                                            <div class="label-field"><i class="bi bi-check check"></i>곡 제목</div><input class="form-tr song-title" type="text" name="song_title[]"  data-target="song_title_view_1_1">
                                            <div class="label-field"><i class="bi bi-check check"></i>곡 아티스트</div><input class="form-tr song-artist" type="text" name="song_artist[]" data-target="artist_view_1_1">
                                        </div>
                                        <div class="info-field">
                                            <div class="label-field"><i class="bi bi-check check"></i>트랙 장르</div>                
                                            <select class="form-select-sm track_genre" name="track_genre[]" style="width: 203px;">
                                                <option selected>선택하세요</option>
                                                {% for g in genre_list %}
                                                <option value="{{ g.genres }}">{{ g.genres }}</td>
                                                {% endfor %}
                                            </select>
                                            <div class="label-field"><i class="bi bi-check check"></i>서비스 언어</div>
                                            <select class="form-select-sm service-lang" name="track_lang[]" style="width: 203px;">
                                                <option selected>선택하세요</option>
                                                <option value="한국어">한국어</option>
                                                <option value="영어">영어</option>
                                                <option value="일본어">일본어</option>
                                            </select>
                                        </div>
                                        <div class="info-field">
                                            <div class="label-field"><i class="bi bi-check check"></i>오픈일</div><input class="form-tr datepicker" type="text" name="tr_opendate[]">
                                            <div class="label-field"><i class="bi bi-check check"></i>ISRC</div><input class="form-tr" type="text" name="isrc[]">
                                        </div>
                                        <div class="info-field jf-item">
                                            <div class="label-field lab-sm"><i class="bi bi-check"></i>대표곡</div><input class="form-check-input" type="checkbox" value="" name="title_song[]">
                                            <div class="label-field lab-sm"><i class="bi bi-check"></i>성인</div><input class="form-check-input" type="checkbox" value="" name="adult[]">
                                        </div>
                                        <div class="info-field">
                                            <div class="label-field lab"><i class="bi bi-check check"></i>음원추가</div><input class="form-control form-control-sm song_file" id="song_file[]" type="file" style="width:250px;"><input class="form-tr track_length" type="text" name="track_length[]"style="width:80px;"><input class="form-control form-control-sm" id="lyric_file[]" type="file"style="width:230px;">
                                        </div>
                                    </div>
                                </div>
                            </th>
                            <th>
                                <div class="info-field-column jf-item">
                                    <div class="info-field"><div class="label-field"><i class="bi bi-check"></i>작사가</div><input class="form-control form-control-sm col" type="text" name="lyricist[]"></div>
                                    <div class="info-field"><div class="label-field"><i class="bi bi-check check"></i>작곡가</div><input class="form-control form-control-sm col" type="text" name="composer[]"></div>
                                    <div class="info-field"><div class="label-field"><i class="bi bi-check check"></i>편곡가</div><input class="form-control form-control-sm col" type="text" name="arranger[]"></div>
                                    <div class="info-field"><div class="label-field"><i class="bi bi-check"></i>참여아티스트</div><input class="form-control form-control-sm col" type="text" name="with_artist[]"></div>
                                    <div class="info-field"><div class="label-field"><i class="bi bi-check"></i>피쳐링아티스트</div><input class="form-control form-control-sm col" type="text" name="featured[]"></div>
                                </div>
                            </th>
                            <th class="text-center">
                                <div class="info-field-column">
                                    <a class='btn btn-danger btn-sm delete-btn'>트랙 삭제</a>
                                </div>
                            </th>
                        </tr>
                    </tbody> -->
                </table>
                <div class="info-field"><button class="btn btn-primary" type="submit" id="album_add">등록하기</button><button class="btn btn-primary" type="submit" id="datafile_up">물리파일 업로드</button></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal 1 -->
<div id="modal1" class="modal">
    <div class="af-modal-content">
        <h5 class="fw-bold mb-2">아티스트 검색</h5>
        <div class="info-field-start">
            <input type="text" class="form-tr">
            <button class="btn btn-primary btn-sm search">검색</button>
        </div>
        <h5 class="fw-bold mb-2">아티스트 리스트</h5>
        <ul class="list-group artist-list" >
            <!-- 아티스트 목록 -->
        </ul>
        <div class="info-field-column my-2">
            <nav aria-label="Page navigation ">
                <ul class="pagination pagination-sm" id="pagination">
                    <!-- 페이지 버튼이 동적으로 추가될 예정 -->
                </ul>
            </nav>
        </div>
        <div class="info-field-column my-2">
            <button class="btn btn-outline-primary btn-sm close-btn">Close</button>
        </div>
    </div>
</div>

<!-- Modal 2 -->
<div id="modal2" class="modal">
    <div class="af-modal-content">
        <h5 class="fw-bold mb-2">아티스트 검색</h5>
        <div class="info-field-start">
            <input type="text" class="form-tr">
            <button class="btn btn-primary btn-sm search">검색</button>
        </div>
        <h5 class="fw-bold mb-2">아티스트 리스트</h5>
        <ul class="list-group artist-list">
            <!-- 아티스트 목록 -->
        </ul>
        <div class="info-field-column my-2">
            <nav aria-label="Page navigation ">
                <ul class="pagination pagination-sm" id="pagination">
                    <!-- 페이지 버튼이 동적으로 추가될 예정 -->
                </ul>
            </nav>
        </div>
        <div class="info-field-column my-2">
            <button class="btn btn-outline-primary btn-sm close-btn">Close</button>
        </div>
    </div>
</div>
<!-- Modal 3 -->
<div id="modal3" class="modal">
    <div class="af-modal-content">
        <h5 class="fw-bold mb-2">권리자 검색</h5>
        <div class="info-field-start">
            <input type="text" class="form-tr">
            <button class="btn btn-primary btn-sm search">검색</button>
        </div>
        <h5 class="fw-bold mb-2">권리자 리스트</h5>
        <ul class="list-group artist-list">
            <!-- 아티스트 목록 -->
        </ul>
        <div class="info-field-column my-2">
            <nav aria-label="Page navigation ">
                <ul class="pagination pagination-sm" id="pagination">
                    <!-- 페이지 버튼이 동적으로 추가될 예정 -->
                </ul>
            </nav>
        </div>
        <div class="info-field-column my-2">
            <button class="btn btn-outline-primary btn-sm close-btn">Close</button>
        </div>
    </div>
</div>

<script>
$(document).ready(function () {

    $("#excel_data_up").click(function () {
        const fileInput = $("<input>").attr({
            type: "file",
            accept: ".xlsx, .xls"
        });

        fileInput.click();

        fileInput.change(function (event) {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (jsonData.length <= 1) {
                    alert("엑셀에 데이터가 없습니다.");
                    return;
                }

                const headers = jsonData[0]; 
                const dataRows = jsonData.slice(1); 

                // ✅ 앨범 정보 등록 (첫 번째 데이터 기준)
                const albumFields = {
                    album_code: 'albumcode',
                    album_title: 'album_title',
                    album_title_en: 'album_title_en',
                    album_artist: 'album_artist',
                    album_genre: 'album_genre',
                    album_Categ: 'album_Categ',
                    album_country: 'album_country',
                    album_copyright: 'album_copyright',
                    album_publish: 'album_publish',
                    startdate: 'startdate',
                    opendate: 'opendate',
                    service_area: 'service_area',
                    excluded: 'excluded',
                    service_lang: 'service_lang',
                    YT_service: 'YT_service',
                    service_time: 'service_time',
                    UCI_code: 'UCI',
                    UPC_code: 'UPC'
                };

                const albumData = dataRows[0]; 

                headers.forEach((header, index) => {
                    const fieldName = header.trim();
                    if (albumFields[fieldName]) {
                        let value = albumData[index] || '';

                        // 날짜 변환
                        if (fieldName === 'startdate' || fieldName === 'opendate') {
                            value = excelDateToJSDate(value);
                        }

                        // 시간 변환
                        if (fieldName === 'service_time') {
                            value = excelTimeToHHMM(value);
                        }

                        // 폼에 값 넣기
                        const input = $(`[name="${albumFields[fieldName]}"]`);
                        if (input.length) {
                            if (input.is("select")) {
                                input.val(value);
                            } else {
                                input.val(value);
                            }
                        }
                    }
                });

                // ✅ 기존 트랙 정보 초기화
                $("#result-table tbody").remove();

                // ✅ 트랙 정보 생성
                dataRows.forEach((row, index) => {
                    const rowData = {};
                    headers.forEach((header, i) => {
                        rowData[header.trim()] = row[i];
                    });

                    const diskNo = rowData["disk_no"] || 1;
                    const trackNo = rowData["track_no"] || (index + 1);

                    createTrackRow(diskNo, trackNo, rowData);
                });

                alert("앨범 정보와 트랙 정보가 성공적으로 생성되었습니다.");
            };

            reader.readAsArrayBuffer(file);
        });
    });

    // ✅ 엑셀 날짜 변환 함수 (일련번호 → YYYY-MM-DD)
    function excelDateToJSDate(serial) {
        if (typeof serial === 'number') {
            const utc_days = Math.floor(serial - 25569);
            const utc_value = utc_days * 86400;
            const date_info = new Date(utc_value * 1000);
            const year = date_info.getFullYear();
            const month = ("0" + (date_info.getMonth() + 1)).slice(-2);
            const day = ("0" + date_info.getDate()).slice(-2);
            return `${year}-${month}-${day}`;
        }
        return serial;
    }

    // ✅ 엑셀 시간 변환 함수 (소수점 → HH:MM)
    function excelTimeToHHMM(serial) {
        if (typeof serial === 'number') {
            let totalMinutes = Math.round(serial * 24 * 60);
            let hours = Math.floor(totalMinutes / 60);
            let minutes = totalMinutes % 60;
            return ("0" + hours).slice(-2) + ":" + ("0" + minutes).slice(-2);
        }
        return serial;
    }

    // ✅ 트랙 생성 함수 (수정된 폼 적용)
    function createTrackRow(diskNo, trackNo, rowData) {
        let tbodyId = `${diskNo}_1`;
        let tbody = $(`#${tbodyId}`);

        if (tbody.length === 0) {
            tbody = $("<tbody></tbody>").attr("id", tbodyId);
            $("#result-table").append(tbody);
        }

        // ✅ 날짜 변환
        let trOpenDate = rowData["tr_opendate"];
        if (typeof trOpenDate === 'number') {
            trOpenDate = excelDateToJSDate(trOpenDate);
        }

        const row = $(`<tr>
            <th class='text-center'><input class="form-ck" type="number" id="disk_no_${diskNo}" name="disk_no[]" style="width: 31px;" value="${diskNo}"></th>
            <th class='text-center'><input class="form-ck" type="number" id="track_no_${trackNo}" name="track_no[]" style="width: 31px;" value="${trackNo}"></th>
            <th class='text-center' id="song_title_view_${diskNo}_${trackNo}">${rowData["song_title"] || ''}</th>
            <th class='text-center' id="artist_view_${diskNo}_${trackNo}">${rowData["song_artist"] || ''}</th>
            <th class='text-center'><i class="bi bi-chevron-up icon" data-target="detail_${diskNo}_${trackNo}"></i></th>
        </tr>
        <tr id="detail_${diskNo}_${trackNo}">
            <th colspan='3'>
                <div class="info-field">
                    <div class="info-field-column">
                        <div class="info-field">
                            <div class="label-field"><i class="bi bi-check check"></i>곡 제목</div><input class="form-tr song-title" type="text" name="song_title[]" value="${rowData["song_title"] || ''}" data-target="song_title_view_${diskNo}_${trackNo}">
                            <div class="label-field"><i class="bi bi-check check"></i>곡 아티스트</div><input class="form-tr song-artist" type="text" name="song_artist[]" value="${rowData["song_artist"] || ''}" data-modal="modal2" data-target="artist_view_${diskNo}_${trackNo}">
                        </div>
                        <div class="info-field">
                            <div class="label-field"><i class="bi bi-check check"></i>트랙 장르</div>
                            <select class="form-select-sm track_genre" name="track_genre[]" style="width: 203px;">
                                <option selected>선택하세요</option>
                                <option value="POP" ${rowData["track_genre"] === 'POP' ? 'selected' : ''}>POP</option>
                                <option value="Dance" ${rowData["track_genre"] === 'Dance' ? 'selected' : ''}>Dance</option>
                                <option value="Hiphop" ${rowData["track_genre"] === 'Hiphop' ? 'selected' : ''}>Hiphop</option>
                                <option value="Newage" ${rowData["track_genre"] === 'Newage' ? 'selected' : ''}>Newage</option>
                                <option value="Indie pop" ${rowData["track_genre"] === 'Indie pop' ? 'selected' : ''}>Indie pop</option>
                                <option value="Indie" ${rowData["track_genre"] === 'Indie' ? 'selected' : ''}>Indie</option>
                                <option value="Indie Rock" ${rowData["track_genre"] === 'Indie Rock' ? 'selected' : ''}>Indie Rock</option>
                                <option value="Indie Folk" ${rowData["track_genre"] === 'Indie Folk' ? 'selected' : ''}>Indie Folk</option>
                                <option value="Folk" ${rowData["track_genre"] === 'Folk' ? 'selected' : ''}>Folk</option>
                                <option value="World" ${rowData["track_genre"] === 'World' ? 'selected' : ''}>World</option>
                                <option value="OST" ${rowData["track_genre"] === 'OST' ? 'selected' : ''}>OST</option>
                                <option value="Trot" ${rowData["track_genre"] === 'Trot' ? 'selected' : ''}>Trot</option>
                                <option value="Instrumental" ${rowData["track_genre"] === 'Instrumental' ? 'selected' : ''}>Instrumental</option>
                            </select>
                            <div class="label-field"><i class="bi bi-check check"></i>서비스 언어</div>
                            <select class="form-select-sm service-lang" name="track_lang[]" style="width: 203px;">
                                <option selected>선택하세요</option>
                                <option value="한국어" ${rowData["track_lang"] === '한국어' ? 'selected' : ''}>한국어</option>
                                <option value="영어" ${rowData["track_lang"] === '영어' ? 'selected' : ''}>영어</option>
                                <option value="일본어" ${rowData["track_lang"] === '일본어' ? 'selected' : ''}>일본어</option>
                            </select>
                        </div>
                        <div class="info-field">
                            <div class="label-field"><i class="bi bi-check check"></i>오픈일</div><input class="form-tr datepicker" type="text" name="tr_opendate[]" value="${trOpenDate || ''}">
                            <div class="label-field"><i class="bi bi-check check"></i>ISRC</div><input class="form-tr" type="text" name="isrc[]" value="${rowData["ISRC"] || ''}">
                        </div>
                        <div class="info-field jf-item">
                            <div class="label-field lab-sm"><i class="bi bi-check"></i>대표곡</div><input class="form-check-input" type="checkbox" name="title_song[]" ${rowData["title_song"] ? 'checked' : ''}>
                            <div class="label-field lab-sm"><i class="bi bi-check"></i>성인</div><input class="form-check-input" type="checkbox" name="adult[]" ${rowData["adult"] ? 'checked' : ''}>
                            <div class="label-field"><i class="bi bi-check check"></i>곡코드</div><input class="form-tr" type="text" name="track_code[]" value="${rowData["track_code"] || ''}">
                        </div>
                        <div class="info-field">
                            <div class="label-field lab"><i class="bi bi-check check"></i>음원추가</div><input class="form-control form-control-sm song_file" id="song_file[]" type="file" style="width:250px;"><input class="form-tr track_length" type="text" name="track_length[]" style="width:80px;"><input class="form-control form-control-sm" id="lyric_file[]" type="file" style="width:230px;">
                        </div>
                    </div>
                </div>
            </th>
            <th>
                <div class="info-field-column jf-item">
                    <div class="info-field"><div class="label-field"><i class="bi bi-check"></i>작사가</div><input class="form-control form-control-sm col" type="text" name="lyricist[]" value="${rowData["lyricist"] || ''}"></div>
                    <div class="info-field"><div class="label-field"><i class="bi bi-check check"></i>작곡가</div><input class="form-control form-control-sm col" type="text" name="composer[]" value="${rowData["composer"] || ''}"></div>
                    <div class="info-field"><div class="label-field"><i class="bi bi-check check"></i>편곡가</div><input class="form-control form-control-sm col" type="text" name="arranger[]" value="${rowData["arranger"] || ''}"></div>
                    <div class="info-field"><div class="label-field"><i class="bi bi-check"></i>참여아티스트</div><input class="form-control form-control-sm col" type="text" name="with_artist[]" value="${rowData["with_artist"] || ''}"></div>
                    <div class="info-field"><div class="label-field"><i class="bi bi-check"></i>피쳐링아티스트</div><input class="form-control form-control-sm col" type="text" name="featured[]" value="${rowData["featured"] || ''}"></div>
                    <div class="info-field"><div class="label-field"><i class="bi bi-check"></i>uci</div><input class="form-control form-control-sm col" type="text" name="uci[]" value="${rowData["UCI"] || ''}"></div>
                </div>
            </th>
            <th class="text-center">
                <div class="info-field-column">
                    <a class='btn btn-danger btn-sm delete-btn'>트랙 삭제</a>
                </div>
            </th>
        </tr>`);

        tbody.append(row);
    }

});
</script>

<script>
$(document).ready(function () {
    $("#setgenreButton").on("click", function (e) {
                e.preventDefault();
                const syncValue = $("#album_genre").val(); // 외부 입력된 값
                $(".track_genre").each(function () {
                    $(this).val(syncValue); // 입력 값 설정
                    const targetId = $(this).data("target");
                    $("#" + targetId).text(syncValue); // 상위 값 갱신
            });
    });
    $("#setdateButton").on("click", function (e) {
                e.preventDefault();
                const syncValue = $("#opendate").val(); // 외부 입력된 값
                $(".datepicker").each(function () {
                    $(this).val(syncValue); // 입력 값 설정
                    const targetId = $(this).data("target");
                    $("#" + targetId).text(syncValue); // 상위 값 갱신
            });
    });
                // 동기화 버튼 클릭 시 모든 song_artist[]에 값 적용
    $("#setArtistButton").on("click", function (e) {
                e.preventDefault();
                const syncValue = $("#album_artist").val(); // 외부 입력된 값
                $(".song-artist").each(function () {
                    $(this).val(syncValue); // 입력 값 설정
                    const targetId = $(this).data("target");
                    $("#" + targetId).text(syncValue); // 상위 값 갱신
            });
    });
    $("#setLangButton").on("click", function (e) {
                e.preventDefault();
                const syncValue = $("#service_lang").val(); // 외부 입력된 값
                $(".service-lang").each(function () {
                    $(this).val(syncValue); // 입력 값 설정
                    const targetId = $(this).data("target");
                    $("#" + targetId).text(syncValue); // 상위 값 갱신
            });
    });
});
</script>
<script>
    $(document).on('click', '.datepicker', function() {
        $(this).datepicker({
		    format: "yyyy-mm-dd",	//데이터 포맷 형식(yyyy : 년 mm : 월 dd : 일 )
		    //startDate: '-10d',	//달력에서 선택 할 수 있는 가장 빠른 날짜. 이전으로는 선택 불가능 ( d : 일 m : 달 y : 년 w : 주)
		    //endDate: '+10d',	//달력에서 선택 할 수 있는 가장 느린 날짜. 이후로 선택 불가 ( d : 일 m : 달 y : 년 w : 주)
		    autoclose : true,	//사용자가 날짜를 클릭하면 자동 캘린더가 닫히는 옵션
		    calendarWeeks : false, //캘린더 옆에 몇 주차인지 보여주는 옵션 기본값 false 보여주려면 true
		    clearBtn : false, //날짜 선택한 값 초기화 해주는 버튼 보여주는 옵션 기본값 false 보여주려면 true
		    //datesDisabled : ['2019-06-24','2019-06-26'],//선택 불가능한 일 설정 하는 배열 위에 있는 format 과 형식이 같아야함.
		    disableTouchKeyboard : false,	//모바일에서 플러그인 작동 여부 기본값 false 가 작동 true가 작동 안함.
		    immediateUpdates: false,	//사용자가 보는 화면으로 바로바로 날짜를 변경할지 여부 기본값 :false 
		    multidate : false, //여러 날짜 선택할 수 있게 하는 옵션 기본값 :false 
		    templates : {
		        leftArrow: '&laquo;',
		        rightArrow: '&raquo;'
		    }, //다음달 이전달로 넘어가는 화살표 모양 커스텀 마이징 
		    showWeekDays : true ,// 위에 요일 보여주는 옵션 기본값 : true
		    todayHighlight : true ,	//오늘 날짜에 하이라이팅 기능 기본값 :false 
		    toggleActive : true,	//이미 선택된 날짜 선택하면 기본값 : false인경우 그대로 유지 true인 경우 날짜 삭제
		    weekStart : 0 ,//달력 시작 요일 선택하는 것 기본값은 0인 일요일 
		    language : "ko"	//달력의 언어 선택, 그에 맞는 js로 교체해줘야한다.
		    
		}).datepicker('show');
	});//ready end
</script>
<script>
// 각 모달을 초기화하는 공통 함수
let currentPage = 1;
let searchQuery = '';

function setupModal(modalId, modelEndpoint, options = {}) {
    const modal = $(`#${modalId}`);
    const searchInput = modal.find('input[type="text"]');
    const searchButton = modal.find('button.search');
    const closeButton = modal.find('button.close-btn');
    const list = modal.find('.artist-list');
    const pagination = modal.find('.pagination');

    let targetInput = null; // 클릭한 input 요소를 추적
  
    // 데이터 로드 함수
    function loadData() {

        const url = `api/${modelEndpoint}/?page=${currentPage}&search=${searchQuery}`;

        $.getJSON(url, function (data) {

        list.empty();
        if (data.error) {
            alert(data.error);
            return;
        }
  
        // 리스트 업데이트
        if (options.updateList) {
          options.updateList(data, list);
        } else {
          data.artists.forEach(artist => {
            const image = artist.Artist_image || "Artist_images/user_image_none.png";
            list.append(
              `<li class="list-group-item artist-item" data-id="${artist.Artist_ID}">
                <div><img src="http://localhost:8000/media/${image}" style="width: 30px;" height="30px;"></div>
                <div style="width: 230px; font-size:13px;">${artist.Artist_name}</div>
                <div style="width: 230px; font-size:13px;">${artist.Artist_ID}</div>
                <div style="width: 230px; font-size:13px;">${artist.category}</div>
              </li>`
            );
          });
        }
  
        // 페이지네이션 업데이트
        updatePagination(data.current_page, data.total_pages);
      });
    }

    // 페이지네이션 생성
    function updatePagination(currentPageFromServer, totalPages) {
        console.log("Updating pagination. Server Current Page:", currentPageFromServer, "Total Pages:", totalPages);
        pagination.empty();
        pagination.append(
        `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage - 1}">&laquo;</a>
        </li>`
        );
        for (let i = 1; i <= totalPages; i++) {
        pagination.append(
            `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>`
        );
        }
        pagination.append(
        `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage + 1}">&raquo;</a>
        </li>`
        );
  
        pagination.find('a').off('click').on('click', function (e) {
            e.preventDefault();
            const page = $(this).data('page');

            if (page && page !== currentPage) {
                currentPage = page; // 전역 변수 업데이트
                console.log("Updated currentPage:", currentPage); // 디버깅
                loadData(); // 새로운 데이터 로드
            }
            });
    }
  
    // 검색 버튼 클릭 이벤트
    searchButton.on('click', function () {
      searchQuery = searchInput.val();
      currentPage = 1; // 검색 시 첫 페이지로 이동
      loadData();
    });
  
    // 리스트 아이템 클릭 이벤트
    list.on('click', '.artist-item', function () {
      const itemName = $(this).find('div:nth-child(2)').text().trim();
      const itemcode = $(this).find('div:nth-child(3)').text().trim();
      const itemId = $(this).data('id');

      // 선택한 값(targetInput)에 결과 설정
      if (targetInput) {
        targetInput.val(`${itemName}`);
        targetInput.next().val(`${itemcode}`);
      }
      modal.fadeOut(); // 모달 닫기
    });
  
    // input 클릭으로 모달 열기
    $(document).on('click', `[data-modal="${modalId}"]`, function () {
        targetInput = $(this); // 클릭한 input 요소 저장
        modal.fadeIn(); // 모달 열기
        loadData(); // 데이터 로드
    });

    // 닫기 버튼 클릭 이벤트
    closeButton.on('click', function () {
        modal.fadeOut(); // 모달 닫기
    });
    // 초기 데이터 로드
    loadData();
  }
  
  // 모달 초기화
  setupModal('modal1', 'artists'); // 모달1: artists 데이터
  setupModal('modal2', 'artists');  // 모달2: albums 데이터
  setupModal('modal3', 'rightholder', {
    updateList: (data, list) => {
      // 모달3 전용 리스트 렌더링
      data.rightholders.forEach(rightholder => {
        list.append(
          `<li class="list-group-item artist-item" data-id="${rightholder.user_code}">
          <div style="width: 100px; font-size:13px;">${rightholder.user_name}</div>
          <div style="width: 100px; font-size:13px;">${rightholder.user_code}</div>
          <div style="width: 300px; font-size:13px;">${rightholder.email}</div>
          <div style="width: 100px; font-size:13px;">${rightholder.user_level}</div>
        </li>`
        );
      });
    }
  });
  
</script>
<script>
$(document).ready(function () {

// ✅ 아티스트 추가 기능
$("#artist_container").on("click", ".artist-add", function () {
    let artistRole = $(this).siblings(".artist-role").val();

    // ✅ 새로운 아티스트 입력 필드 추가
    let newArtistField = `
        <div class="info-field-start mb-2" id="artist_info">
            <div class="label-field"><i class="bi bi-check check"></i>아티스트 찾기</div>
            <select class="form-select-sm artist-role" style="width: 120px;">
                <option value="Main" ${artistRole === "Main" ? "selected" : ""}>메인</option>
                <option value="With" ${artistRole === "With" ? "selected" : ""}>참여</option>
                <option value="Feat" ${artistRole === "Feat" ? "selected" : ""}>피쳐링</option>
            </select>
            <input class="form-in find_artist" type="text" data-modal="modal1" placeholder="아티스트 이름">
            <input class="form-in artist-code" type="text" name="album_artist_code" style="width: 120px;" placeholder="아티스트 ID">
            <a class="btn btn-outline-danger btn-sm artist-add">추가</a>
            <a class="btn btn-outline-success btn-sm artist-delete">삭제</a>
        </div>
    `;
    $("#artist_container").append(newArtistField);
});

// ✅ 아티스트 삭제 기능
$("#artist_container").on("click", ".artist-delete", function () {
    $(this).closest("#artist_info").remove();
});

// ✅ 아티스트 등록 기능
$("#artist_summit").on("click", function () {
    let mainArtistNames = [];
    let mainArtistIDs = [];
    let withArtistNames = [];
    let withArtistIDs = [];
    let featArtistNames = [];
    let featArtistIDs = [];

    // ✅ 모든 아티스트 입력 필드 순회
    $("#artist_container .info-field-start").each(function () {
        let artistName = $(this).find(".find_artist").val().trim();
        let artistID = $(this).find(".artist-code").val().trim();
        let artistRole = $(this).find(".artist-role").val();

        if (artistRole === "Main" && artistName && artistID) {
            mainArtistNames.push(artistName);
            mainArtistIDs.push(artistID);
        } else if (artistRole === "With" && artistName && artistID) {
            withArtistNames.push(artistName);
            withArtistIDs.push(artistID);
        } else if (artistRole === "Feat" && artistName && artistID) {
            featArtistNames.push(artistName);
            featArtistIDs.push(artistID);
        }
    });

    // ✅ 쉼표로 구분된 문자열로 변환
    let joinedMainNames = mainArtistNames.join(", ");
    let joinedMainIDs = mainArtistIDs.join(", ");
    let joinedWithNames = withArtistNames.join(", ");
    let joinedWithIDs = withArtistIDs.join(", ");
    let joinedFeatNames = featArtistNames.join(", ");
    let joinedFeatIDs = featArtistIDs.join(", ");

    // ✅ 각 필드에 값 입력
    $("#album_artist").val(joinedMainNames);            // ✅ 메인 아티스트 이름 (추가)
    $("#album_artist_roll").val(joinedMainNames);       // 메인 아티스트 이름 목록
    $("#album_artist_id_roll").val(joinedMainIDs);      // 메인 아티스트 ID
    $("#album_with_artist_roll").val(joinedWithNames);  // 참여 아티스트 이름
    $("#album_with_artist_id_roll").val(joinedWithIDs); // 참여 아티스트 ID
    $("#album_feat_artist_roll").val(joinedFeatNames);  // 피쳐링 아티스트 이름
    $("#album_feat_artist_id_roll").val(joinedFeatIDs); // 피쳐링 아티스트 ID

    // ✅ 결과 확인용 콘솔 로그

});
});

</script>

{% endblock %}